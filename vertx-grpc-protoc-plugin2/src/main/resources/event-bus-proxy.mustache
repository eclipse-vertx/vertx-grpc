{{#javaPackageFqn}}
package {{javaPackageFqn}};
{{/javaPackageFqn}}

import io.vertx.core.Future;
import io.vertx.core.Vertx;
import io.vertx.core.buffer.Buffer;
import io.vertx.core.eventbus.DeliveryOptions;
import io.vertx.core.streams.ReadStream;

/**
 * <p>Event bus proxy for the {{serviceName}} gRPC service.</p>
 *
 * <p>Implements the {@link {{contractFqn}}} contract interface by sending protobuf-serialized
 * messages over the Vert.x event bus. Only unary-unary methods are supported.</p>
 *
 * <p>Address format: {@code {{packageName}}.{{serviceName}}/MethodName}</p>
 */
public class {{eventBusProxyFqn}} implements {{contractFqn}} {

  private final Vertx vertx;
  private final DeliveryOptions options;

  public {{eventBusProxyFqn}}(Vertx vertx) {
    this(vertx, null);
  }

  public {{eventBusProxyFqn}}(Vertx vertx, DeliveryOptions options) {
    this.vertx = vertx;
    this.options = options;
  }
{{#unaryUnaryMethods}}

  @Override
  public Future<{{outputType}}> {{vertxMethodName}}({{inputType}} request) {
    DeliveryOptions deliveryOptions = (options != null) ? new DeliveryOptions(options) : new DeliveryOptions();
    return vertx.eventBus().<Buffer>request("{{packageName}}.{{serviceName}}/{{methodName}}", Buffer.buffer(request.toByteArray()), deliveryOptions)
      .map(msg -> {
        try {
          return {{outputType}}.parseFrom(msg.body().getBytes());
        } catch (com.google.protobuf.InvalidProtocolBufferException e) {
          throw new RuntimeException(e);
        }
      });
  }
{{/unaryUnaryMethods}}
{{#unaryManyMethods}}

  @Override
  public Future<ReadStream<{{outputType}}>> {{vertxMethodName}}({{inputType}} request) {
    throw new UnsupportedOperationException("Streaming methods are not supported over the event bus");
  }
{{/unaryManyMethods}}
{{#manyUnaryMethods}}

  @Override
  public Future<{{outputType}}> {{vertxMethodName}}(ReadStream<{{inputType}}> request) {
    throw new UnsupportedOperationException("Streaming methods are not supported over the event bus");
  }
{{/manyUnaryMethods}}
{{#manyManyMethods}}

  @Override
  public Future<ReadStream<{{outputType}}>> {{vertxMethodName}}(ReadStream<{{inputType}}> request) {
    throw new UnsupportedOperationException("Streaming methods are not supported over the event bus");
  }
{{/manyManyMethods}}
}
